name: Release
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Get version from tag
        id: get_version
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          $safe_version = $version -replace '\.', '-'
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "SAFE_VERSION=$safe_version" >> $env:GITHUB_OUTPUT
          echo "TAG=$tag" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Update version in code
        run: |
          $content = Get-Content -Path "index.ts" -Raw
          $content = $content -replace 'const VERSION = "[^"]*"', 'const VERSION = "${{ steps.get_version.outputs.VERSION }}"'
          Set-Content -Path "index.ts" -Value $content -NoNewline
        shell: pwsh

      - name: Build Project
        run: bun run build_win_cert

      - name: Rename and Zip Artifact
        run: |
          $safeVersion = "${{ steps.get_version.outputs.SAFE_VERSION }}"
          $exeName = "receiver-server-$safeVersion.exe"
          $zipName = "receiver-server-$safeVersion.zip"
          
          Move-Item -Path "./dist/receiver-server.exe" -Destination "./dist/$exeName"
          
          if (Test-Path "./dist/$zipName") { Remove-Item "./dist/$zipName" -Force }
          
          Compress-Archive -Path "./dist/$exeName" -DestinationPath "./dist/$zipName"
        shell: pwsh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: receiver-server-${{ steps.get_version.outputs.SAFE_VERSION }}
          path: ./dist/receiver-server-${{ steps.get_version.outputs.SAFE_VERSION }}.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          pattern: receiver-server-*
          merge-multiple: true
          path: .

      - name: Get version from tag
        id: get_version
        run: |
          tag="${{ github.ref_name }}"
          version="${tag#v}"
          safe_version="${version//./-}"
          echo "SAFE_VERSION=$safe_version" >> $GITHUB_OUTPUT
        shell: bash

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: receiver-server-${{ steps.get_version.outputs.SAFE_VERSION }}.zip
          draft: false
          prerelease: false
